<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>용산구 방문 지도 (공유형)</title>
    
    <!-- 네이버 지도 API (기존 Key 유지) -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=u5mtazxcnw"></script>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100vh; }
        
        /* 기존 디자인 스타일 유지 */
        .iw-container { 
            padding: 12px;
            min-width: 180px;
            background-color: white; 
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .iw-title { 
            font-size: 15px; 
            font-weight: 700; 
            color: #222; 
            margin-bottom: 8px;
            display: block;
            text-align: center;
        }
        .iw-btn {
            display: block;
            text-align: center;
            background-color: #03c75a;
            color: white;
            padding: 8px 0;
            text-decoration: none;
            font-size: 12px;
            border-radius: 4px;
            font-weight: 600;
            margin-bottom: 5px;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        /* 방문 완료 버튼 스타일 */
        .iw-btn.visited {
            background-color: #f59e0b; /* 오렌지색 */
        }
        .iw-btn.check {
            background-color: #3b82f6; /* 파란색 */
        }
        
        /* 로딩 화면 */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; items-center: center; justify-content: center;
            font-weight: bold; color: #333;
        }
    </style>
</head>
<body>

<div id="loading">데이터를 불러오는 중입니다...</div>
<div id="map"></div>

<script>
    // --- [중요 설정] 복사한 구글 앱스 스크립트 URL을 여기에 넣으세요 ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxke58cFRqE5zTU1pDEKDG9kuQvBKsvWx-Otfz4dzlrPPYlj0lssc2LOMFTsvBbcFaK/exec'; 

    var map;
    var infowindow = new naver.maps.InfoWindow({
        borderWidth: 0,
        disableAnchor: false,
        backgroundColor: "transparent",
        pixelOffset: new naver.maps.Point(0, -5)
    });

    // 1. 지도 초기화
    function initMap() {
        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5321161, 127.0056662), // 용산구 중심
            zoom: 14
        });
        loadData();
    }

    // 2. 구글 시트에서 데이터 가져오기
    async function loadData() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const locations = await response.json();
            document.getElementById('loading').style.display = 'none';

            locations.forEach(function(loc) {
                if(loc.Lat && loc.Lng) {
                    createMarker(loc);
                }
            });
        } catch (error) {
            console.error("데이터 로딩 실패:", error);
            alert("데이터를 불러오지 못했습니다. URL 설정을 확인해주세요.");
        }
    }

    // 3. 마커 및 정보창 생성
    function createMarker(loc) {
        const isVisited = String(loc.IsVisited).toUpperCase() === 'TRUE';
        
        // 방문 여부에 따라 마커 디자인 차별화 (옵션)
        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(loc.Lat, loc.Lng),
            map: map,
            title: loc.Name,
            icon: {
                content: `<div style="background:${isVisited ? '#10b981' : '#ef4444'}; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>`,
                anchor: new naver.maps.Point(10, 10)
            }
        });

        naver.maps.Event.addListener(marker, "click", function() {
            var infoContent = [
                '<div class="iw-container">',
                '   <span class="iw-title">' + loc.Name + '</span>',
                '   <button onclick="updateStatus(\''+loc.ID+'\', '+!isVisited+')" class="iw-btn '+(isVisited ? 'visited' : 'check')+'">',
                '       ' + (isVisited ? '방문 취소하기' : '방문 완료 체크'),
                '   </button>',
                '   <a href="https://map.naver.com/v5/search/' + encodeURIComponent(loc.Name) + '" target="_blank" class="iw-btn">네이버 지도 보기</a>',
                '</div>'
            ].join('');

            infowindow.setContent(infoContent);
            infowindow.open(map, marker);
        });
    }

    // 4. 방문 상태 업데이트 기능
    async function updateStatus(id, nextStatus) {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading').innerText = "기록 중...";
        
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ id: id, isVisited: nextStatus })
            });
            
            // 업데이트 후 즉시 새로고침하여 반영
            location.reload();
        } catch (error) {
            alert("업데이트에 실패했습니다.");
            document.getElementById('loading').style.display = 'none';
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
